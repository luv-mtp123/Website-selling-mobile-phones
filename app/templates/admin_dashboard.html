{% extends 'base.html' %}

{% block content %}
<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .th-sort:hover {
        background-color: #f1f1f1;
    }

    .sort-icon {
        font-size: 0.8rem;
        margin-left: 5px;
        color: #ccc;
    }

    .sort-active {
        color: #0d6efd !important;
    }

    /* Style m·ªõi cho Analytics Card */
    .stat-card {
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
</style>

<!-- T·∫£i Chart.js t·ª´ CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h2 class="mb-4 text-primary fw-bold"><i class="fas fa-chart-line"></i> Dashboard Th·ªëng K√™</h2>

<!-- KHI V·ª∞C TH·ªêNG K√ä (ANALYTICS) -->
<div class="row mb-4 g-3">
    <!-- Doanh Thu -->
    <div class="col-md-3">
        <div class="card bg-success text-white border-0 shadow-sm rounded-3 stat-card">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0 opacity-75 small">T·ªïng Doanh Thu</p>
                        <h4 class="fw-bold mb-0">{{ "{:,.0f}".format(total_revenue) }} ƒë</h4>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-circle p-2">
                        <i class="fas fa-money-bill-wave fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- T·ªïng ƒê∆°n -->
    <div class="col-md-3">
        <div class="card bg-primary text-white border-0 shadow-sm rounded-3 stat-card">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0 opacity-75 small">T·ªïng ƒê∆°n H√†ng</p>
                        <h4 class="fw-bold mb-0">{{ orders|length }}</h4>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-circle p-2">
                        <i class="fas fa-shopping-bag fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- T·ªïng S·∫£n Ph·∫©m -->
    <div class="col-md-3">
        <div class="card bg-info text-dark border-0 shadow-sm rounded-3 stat-card">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0 opacity-75 small">S·∫£n Ph·∫©m</p>
                        <h4 class="fw-bold mb-0">{{ products|length }}</h4>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-circle p-2">
                        <i class="fas fa-mobile-alt fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th√†nh Vi√™n -->
    <div class="col-md-3">
        <div class="card bg-warning text-dark border-0 shadow-sm rounded-3 stat-card">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-0 opacity-75 small">Th√†nh Vi√™n</p>
                        <h4 class="fw-bold mb-0">{{ users|length }}</h4>
                    </div>
                    <div class="bg-white bg-opacity-25 rounded-circle p-2">
                        <i class="fas fa-users fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KHI V·ª∞C BI·ªÇU ƒê·ªí (CHARTS) -->
<div class="row mb-5 g-4">
    <!-- Bi·ªÉu ƒë·ªì Doanh thu -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-area me-1"></i> Doanh thu 7 ng√†y g·∫ßn nh·∫•t
                </h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì Tr·∫°ng th√°i ƒë∆°n & Top s·∫£n ph·∫©m -->
    <div class="col-lg-4">
        <!-- Tr·∫°ng th√°i ƒë∆°n -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-success"><i class="fas fa-chart-pie me-1"></i> Tr·∫°ng th√°i ƒë∆°n h√†ng</h6>
            </div>
            <div class="card-body">
                <div style="height: 200px; position: relative;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top s·∫£n ph·∫©m b√°n ch·∫°y -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-warning"><i class="fas fa-crown me-1"></i> Top B√°n Ch·∫°y</h6>
            </div>
            <ul class="list-group list-group-flush small">
                {% for prod in top_products %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ prod[0] }}
                    <span class="badge bg-primary rounded-pill">{{ prod[1] }} ƒë√£ b√°n</span>
                </li>
                {% else %}
                <li class="list-group-item text-muted text-center">Ch∆∞a c√≥ d·ªØ li·ªáu b√°n h√†ng</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Tabs Qu·∫£n l√Ω Chi ti·∫øt (Gi·ªØ nguy√™n) -->
<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active fw-bold" data-bs-toggle="pill" data-bs-target="#pills-product">S·∫£n ph·∫©m</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#pills-order">ƒê∆°n h√†ng</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#pills-user">Ng∆∞·ªùi d√πng</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold text-success" data-bs-toggle="pill" data-bs-target="#pills-tradein">Thu c≈© ƒë·ªïi
            m·ªõi</button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">

    <!-- TAB 1: S·∫£n ph·∫©m -->
    <div class="tab-pane fade show active" id="pills-product">
        <div class="card shadow border-0 rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white p-3 d-flex justify-content-between align-items-center border-bottom">
                <h5 class="mb-0 fw-bold text-dark">Kho h√†ng & S·∫£n ph·∫©m</h5>
                <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal"
                    data-bs-target="#addProductModal">
                    <i class="fas fa-plus me-2"></i> Th√™m m·ªõi
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="productTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 cursor-pointer th-sort" onclick="sortProductTable(0, 'int')">
                                    ID <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th style="width: 60px;">·∫¢nh</th>
                                <th class="cursor-pointer th-sort" onclick="sortProductTable(2, 'str')">
                                    T√™n s·∫£n ph·∫©m <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="cursor-pointer th-sort" onclick="sortProductTable(3, 'int')">
                                    Gi√° b√°n <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="cursor-pointer th-sort" onclick="sortProductTable(4, 'int')">
                                    T·ªìn kho <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in products %}
                            <tr class="{% if not p.is_active %}table-secondary opacity-75{% endif %}">
                                <td class="ps-4 fw-bold text-muted">#{{ p.id }}</td>
                                <td><img src="{{ p.image_url }}" style="width: 50px; height: 50px; object-fit: cover;"
                                        class="rounded border" onerror="this.src='https://via.placeholder.com/50'"></td>
                                <td>
                                    <div class="fw-bold text-primary">{{ p.name }}</div>
                                    <span class="badge bg-light text-dark border">{{ p.brand }}</span>
                                    {% if p.is_sale %}<span class="badge bg-danger">Sale</span>{% endif %}
                                    {% if not p.is_active %}<span class="badge bg-secondary">·∫®n</span>{% endif %}
                                </td>
                                <td class="fw-bold text-danger">
                                    {{ "{:,.0f}".format(p.sale_price if p.is_sale else p.price) }} ƒë
                                </td>
                                <td>
                                    {% if p.stock_quantity > 0 %}
                                    <span class="badge bg-success rounded-pill px-3">{{ p.stock_quantity }}</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">H·∫øt h√†ng</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/product/{{ p.id }}" class="btn btn-sm btn-outline-info me-1"
                                        target="_blank"><i class="fas fa-eye"></i></a>
                                    <a href="/admin/product/edit/{{ p.id }}"
                                        class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-edit"></i></a>
                                    <a href="/admin/product/delete/{{ p.id }}" class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')"><i
                                            class="fas fa-trash-alt"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: ƒê∆°n h√†ng -->
    <div class="tab-pane fade" id="pills-order">
        <div class="card shadow border-0 rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white p-3">
                <h5 class="mb-0 fw-bold">Danh s√°ch ƒê∆°n h√†ng</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>ID</th>
                                <th>Kh√°ch</th>
                                <th>T·ªïng ti·ªÅn</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th>X·ª≠ l√Ω</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for o in orders %}
                            <tr>
                                <td class="ps-4 fw-bold">#{{ o.id }}</td>
                                <td>
                                    <div class="fw-bold">{{ o.user.full_name or o.user.username }}</div><small>{{
                                        o.phone }}</small>
                                </td>
                                <td class="fw-bold text-danger">{{ "{:,.0f}".format(o.total_price) }} ƒë</td>
                                <td>
                                    <span
                                        class="badge bg-{{ 'warning' if o.status=='Pending' else 'success' if o.status=='Completed' else 'secondary' if o.status=='Cancelled' else 'primary' }}">
                                        {{ o.status }}
                                    </span>
                                </td>
                                <td>{{ o.date_created.strftime('%d/%m %H:%M') }}</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                            data-bs-toggle="dropdown" {% if o.status in ['Completed', 'Cancelled' ]
                                            %}disabled{% endif %}>H√†nh ƒë·ªông</button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item text-primary"
                                                    href="/admin/order/update/{{ o.id }}/Confirmed">‚úî X√°c nh·∫≠n</a></li>
                                            <li><a class="dropdown-item text-info"
                                                    href="/admin/order/update/{{ o.id }}/Shipping">üöö Giao h√†ng</a></li>
                                            <li><a class="dropdown-item text-success"
                                                    href="/admin/order/update/{{ o.id }}/Completed">‚úÖ Ho√†n th√†nh</a>
                                            </li>
                                            <li><a class="dropdown-item text-danger"
                                                    href="/admin/order/update/{{ o.id }}/Cancelled">‚úñ H·ªßy ƒë∆°n</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: Ng∆∞·ªùi d√πng -->
    <div class="tab-pane fade" id="pills-user">
        <div class="card shadow border-0 rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white p-3">
                <h5 class="mb-0 fw-bold">Danh s√°ch Th√†nh vi√™n</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Avatar</th>
                                <th>T√†i kho·∫£n</th>
                                <th>H·ªç t√™n</th>
                                <th>Vai tr√≤</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in users %}
                            <tr>
                                <td class="ps-4">#{{ u.id }}</td>
                                <td><img src="{{ u.avatar_url or 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' }}"
                                        class="rounded-circle border" width="40" height="40"></td>
                                <td>
                                    <div class="fw-bold">{{ u.username }}</div><small class="text-muted">{{ u.email
                                        }}</small>
                                </td>
                                <td>{{ u.full_name or '---' }}</td>
                                <td>
                                    {% if u.role == 'admin' %}
                                    <span class="badge bg-danger">ADMIN</span>
                                    {% else %}
                                    <span class="badge bg-info text-dark">User</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 4: Thu c≈© ƒë·ªïi m·ªõi -->
    <div class="tab-pane fade" id="pills-tradein">
        <div class="card shadow border-0 p-3">
            <h5>Y√™u c·∫ßu ƒë·ªãnh gi√°</h5>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>·∫¢nh</th>
                        <th>Thi·∫øt b·ªã</th>
                        <th>Ng∆∞·ªùi g·ª≠i</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in tradeins %}
                    <tr>
                        <td><a href="{{ item.image_proof }}" target="_blank"><img src="{{ item.image_proof }}"
                                    style="width: 50px;"></a></td>
                        <td>{{ item.device_name }}<br><small>{{ item.condition }}</small></td>
                        <td>{{ item.user.username }}</td>
                        <td><span class="badge bg-{{ 'success' if item.status=='Approved' else 'warning' }}">{{
                                item.status }}</span></td>
                        <td>
                            {% if item.status == 'Pending' %}
                            <button class="btn btn-sm btn-success"
                                onclick="openValuationModal('{{ item.id }}', '{{ item.device_name }}')">ƒê·ªãnh
                                gi√°</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Th√™m S·∫£n ph·∫©m -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form action="/admin/product/add" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">T√™n s·∫£n ph·∫©m</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">H√£ng</label>
                            <input type="text" name="brand" class="form-control" list="brands" required>
                            <datalist id="brands">
                                <option value="Apple">
                                <option value="Samsung">
                                <option value="Xiaomi">
                                <option value="Oppo">
                            </datalist>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Gi√° b√°n (VNƒê)</label>
                            <input type="number" name="price" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-success">S·ªë l∆∞·ª£ng t·ªìn kho</label>
                            <input type="number" name="stock_quantity" class="form-control border-success" value="10"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Lo·∫°i</label>
                            <select name="category" class="form-select">
                                <option value="phone">ƒêi·ªán tho·∫°i</option>
                                <option value="accessory">Ph·ª• ki·ªán</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">URL H√¨nh ·∫£nh</label>
                            <input type="text" name="image_url" class="form-control" placeholder="https://..." required>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">M√¥ t·∫£</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-12 d-flex gap-3">
                            <div class="bg-light p-2 rounded flex-grow-1">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="activeSwitch"
                                        checked>
                                    <label class="form-check-label fw-bold" for="activeSwitch">Active</label>
                                </div>
                            </div>
                            <div class="bg-light p-2 rounded flex-grow-1">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_sale" id="saleSwitch">
                                    <label class="form-check-label fw-bold" for="saleSwitch">Gi·∫£m gi√°?</label>
                                </div>
                                <input type="number" name="sale_price" class="form-control mt-2 form-control-sm"
                                    placeholder="Gi√° sau gi·∫£m">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal ƒê·ªãnh gi√° -->
<div class="modal fade" id="valuationModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/admin/tradein/update" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ƒê·ªãnh gi√° thi·∫øt b·ªã</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="valId">
                    <p>Thi·∫øt b·ªã: <strong id="valDevice"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Gi√° thu mua</label>
                        <input type="number" name="valuation_price" class="form-control fw-bold text-success">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea name="admin_note" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="action" value="reject" class="btn btn-secondary">T·ª´ ch·ªëi</button>
                    <button type="submit" name="action" value="approve" class="btn btn-success fw-bold">X√°c
                        nh·∫≠n</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function openValuationModal(id, name) {
        document.getElementById('valId').value = id;
        document.getElementById('valDevice').innerText = name;
        new bootstrap.Modal(document.getElementById('valuationModal')).show();
    }

    // Logic S·∫Øp x·∫øp b·∫£ng S·∫£n ph·∫©m
    let sortOrders = {};
    function sortProductTable(n, type) {
        const table = document.getElementById("productTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        sortOrders[n] = !sortOrders[n];
        const isAsc = sortOrders[n];
        rows.sort((a, b) => {
            let valA = a.cells[n].innerText.trim();
            let valB = b.cells[n].innerText.trim();
            if (type === 'int') {
                valA = parseInt(valA.replace(/[^\d]/g, '')) || 0;
                valB = parseInt(valB.replace(/[^\d]/g, '')) || 0;
                return isAsc ? valA - valB : valB - valA;
            } else {
                return isAsc ? valA.localeCompare(valB, 'vi') : valB.localeCompare(valA, 'vi');
            }
        });
        rows.forEach(row => tbody.appendChild(row));
    }

    // --- SETUP BI·ªÇU ƒê·ªí CHART.JS ---
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Bi·ªÉu ƒë·ªì Doanh Thu (Line Chart)
        const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(ctxRevenue, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ chart_dates | safe }}'), // Nh·∫≠n d·ªØ li·ªáu t·ª´ Flask
                datasets: [{
                    label: 'Doanh thu (VNƒê)',
                    data: JSON.parse('{{ chart_revenues | safe }}'),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });

        // 2. Bi·ªÉu ƒë·ªì Tr·∫°ng Th√°i (Doughnut Chart)
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        const statusDataRaw = {{ status_data | tojson
    }}; // D·ªØ li·ªáu d·∫°ng Object {Pending: 5, Completed: 2...}
    const labels = Object.keys(statusDataRaw);
    const data = Object.values(statusDataRaw);

    // M√†u s·∫Øc t∆∞∆°ng ·ª©ng v·ªõi class Bootstrap (Warning, Success, Info...)
    const colors = {
        'Pending': '#ffc107',
        'Confirmed': '#0d6efd',
        'Shipping': '#0dcaf0',
        'Completed': '#198754',
        'Cancelled': '#6c757d'
    };
    const bgColors = labels.map(l => colors[l] || '#ccc');

    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: bgColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    });
</script>
{% endblock %}