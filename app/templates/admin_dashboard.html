{% extends 'base.html' %}

{% block content %}
<style>
    .cursor-pointer { cursor: pointer; }
    .th-sort:hover { background-color: #f1f1f1; }
    .sort-icon { font-size: 0.8rem; margin-left: 5px; color: #ccc; }
    .sort-active { color: #0d6efd !important; }
</style>

<h2 class="mb-4 text-primary fw-bold"><i class="fas fa-user-shield"></i> Trang Qu·∫£n Tr·ªã (Admin)</h2>

<!-- Th·ªëng k√™ -->
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card bg-primary text-white border-0 shadow-sm rounded-3">
            <div class="card-body d-flex align-items-center justify-content-between p-4">
                <div>
                    <h2 class="fw-bold mb-0">{{ products|length }}</h2>
                    <p class="mb-0 opacity-75">S·∫£n ph·∫©m</p>
                </div>
                <i class="fas fa-mobile-alt fa-3x opacity-50"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white border-0 shadow-sm rounded-3">
            <div class="card-body d-flex align-items-center justify-content-between p-4">
                <div>
                    <h2 class="fw-bold mb-0">{{ users|length }}</h2>
                    <p class="mb-0 opacity-75">Ng∆∞·ªùi d√πng</p>
                </div>
                <i class="fas fa-users fa-3x opacity-50"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-dark border-0 shadow-sm rounded-3">
            <div class="card-body d-flex align-items-center justify-content-between p-4">
                <div>
                    <h2 class="fw-bold mb-0">{{ orders|length }}</h2>
                    <p class="mb-0 opacity-75">ƒê∆°n h√†ng</p>
                </div>
                <i class="fas fa-shopping-bag fa-3x opacity-50"></i>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Qu·∫£n l√Ω -->
<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active fw-bold" data-bs-toggle="pill" data-bs-target="#pills-product">S·∫£n ph·∫©m</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#pills-order">ƒê∆°n h√†ng</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#pills-user">Ng∆∞·ªùi d√πng</button>
    </li>
    <li class="nav-item">
        <button class="nav-link fw-bold text-success" data-bs-toggle="pill" data-bs-target="#pills-tradein">Thu c≈© ƒë·ªïi m·ªõi</button>
    </li>
</ul>

<div class="tab-content" id="pills-tabContent">

    <!-- TAB 1: S·∫£n ph·∫©m -->
    <div class="tab-pane fade show active" id="pills-product">
        <div class="card shadow border-0 rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white p-3 d-flex justify-content-between align-items-center border-bottom">
                <h5 class="mb-0 fw-bold text-dark">Kho h√†ng & S·∫£n ph·∫©m</h5>
                <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i class="fas fa-plus me-2"></i> Th√™m m·ªõi
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="productTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 cursor-pointer th-sort" onclick="sortProductTable(0, 'int')">
                                    ID <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th style="width: 60px;">·∫¢nh</th>
                                <th class="cursor-pointer th-sort" onclick="sortProductTable(2, 'str')">
                                    T√™n s·∫£n ph·∫©m <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="cursor-pointer th-sort" onclick="sortProductTable(3, 'int')">
                                    Gi√° b√°n <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="cursor-pointer th-sort" onclick="sortProductTable(4, 'int')">
                                    T·ªìn kho <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in products %}
                            <tr class="{% if not p.is_active %}table-secondary opacity-75{% endif %}">
                                <td class="ps-4 fw-bold text-muted">#{{ p.id }}</td>
                                <td><img src="{{ p.image_url }}" style="width: 50px; height: 50px; object-fit: cover;" class="rounded border" onerror="this.src='https://via.placeholder.com/50'"></td>
                                <td>
                                    <div class="fw-bold text-primary">{{ p.name }}</div>
                                    <span class="badge bg-light text-dark border">{{ p.brand }}</span>
                                    {% if p.is_sale %}<span class="badge bg-danger">Sale</span>{% endif %}
                                    {% if not p.is_active %}<span class="badge bg-secondary">·∫®n</span>{% endif %}
                                </td>
                                <td class="fw-bold text-danger">
                                    {{ "{:,.0f}".format(p.sale_price if p.is_sale else p.price) }} ƒë
                                </td>
                                <td>
                                    {% if p.stock_quantity > 0 %}
                                        <span class="badge bg-success rounded-pill px-3">{{ p.stock_quantity }}</span>
                                    {% else %}
                                        <span class="badge bg-danger rounded-pill px-3">H·∫øt h√†ng</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/product/{{ p.id }}" class="btn btn-sm btn-outline-info me-1" target="_blank"><i class="fas fa-eye"></i></a>
                                    <a href="/admin/product/edit/{{ p.id }}" class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-edit"></i></a>
                                    <a href="/admin/product/delete/{{ p.id }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')"><i class="fas fa-trash-alt"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: ƒê∆°n h√†ng -->
    <div class="tab-pane fade" id="pills-order">
        <div class="card shadow border-0 rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white p-3"><h5 class="mb-0 fw-bold">Danh s√°ch ƒê∆°n h√†ng</h5></div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr><th>ID</th><th>Kh√°ch</th><th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>Ng√†y ƒë·∫∑t</th><th>X·ª≠ l√Ω</th></tr>
                        </thead>
                        <tbody>
                            {% for o in orders %}
                            <tr>
                                <td class="ps-4 fw-bold">#{{ o.id }}</td>
                                <td><div class="fw-bold">{{ o.user.full_name or o.user.username }}</div><small>{{ o.phone }}</small></td>
                                <td class="fw-bold text-danger">{{ "{:,.0f}".format(o.total_price) }} ƒë</td>
                                <td><span class="badge bg-{{ 'warning' if o.status=='Pending' else 'success' if o.status=='Completed' else 'secondary' if o.status=='Cancelled' else 'primary' }}">{{ o.status }}</span></td>
                                <td>{{ o.date_created.strftime('%d/%m') }}</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" {% if o.status in ['Completed', 'Cancelled'] %}disabled{% endif %}>H√†nh ƒë·ªông</button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item text-primary" href="/admin/order/update/{{ o.id }}/Confirmed">‚úî X√°c nh·∫≠n</a></li>
                                            <li><a class="dropdown-item text-info" href="/admin/order/update/{{ o.id }}/Shipping">üöö Giao h√†ng</a></li>
                                            <li><a class="dropdown-item text-success" href="/admin/order/update/{{ o.id }}/Completed">‚úÖ Ho√†n th√†nh</a></li>
                                            <li><a class="dropdown-item text-danger" href="/admin/order/update/{{ o.id }}/Cancelled">‚úñ H·ªßy ƒë∆°n</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: Ng∆∞·ªùi d√πng -->
    <div class="tab-pane fade" id="pills-user">
        <div class="card shadow border-0 rounded-4 overflow-hidden mb-5">
            <div class="card-header bg-white p-3"><h5 class="mb-0 fw-bold">Danh s√°ch Th√†nh vi√™n</h5></div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Avatar</th>
                                <th>T√†i kho·∫£n</th>
                                <th>H·ªç t√™n</th>
                                <th>Vai tr√≤</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in users %}
                            <tr>
                                <td class="ps-4">#{{ u.id }}</td>
                                <td><img src="{{ u.avatar_url or 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' }}" class="rounded-circle border" width="40" height="40"></td>
                                <td><div class="fw-bold">{{ u.username }}</div><small class="text-muted">{{ u.email }}</small></td>
                                <td>{{ u.full_name or '---' }}</td>
                                <td>
                                    {% if u.role == 'admin' %}
                                        <span class="badge bg-danger">ADMIN</span>
                                    {% else %}
                                        <span class="badge bg-info text-dark">User</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 4: Thu c≈© ƒë·ªïi m·ªõi -->
    <div class="tab-pane fade" id="pills-tradein">
        <div class="card shadow border-0 p-3">
            <h5>Y√™u c·∫ßu ƒë·ªãnh gi√°</h5>
            <table class="table table-hover">
                <thead><tr><th>·∫¢nh</th><th>Thi·∫øt b·ªã</th><th>Ng∆∞·ªùi g·ª≠i</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
                <tbody>
                    {% for item in tradeins %}
                    <tr>
                        <td><a href="{{ item.image_proof }}" target="_blank"><img src="{{ item.image_proof }}" style="width: 50px;"></a></td>
                        <td>{{ item.device_name }}<br><small>{{ item.condition }}</small></td>
                        <td>{{ item.user.username }}</td>
                        <td><span class="badge bg-{{ 'success' if item.status=='Approved' else 'warning' }}">{{ item.status }}</span></td>
                        <td>
                            {% if item.status == 'Pending' %}
                            <button class="btn btn-sm btn-success" onclick="openValuationModal('{{ item.id }}', '{{ item.device_name }}')">ƒê·ªãnh gi√°</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Th√™m S·∫£n ph·∫©m -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form action="/admin/product/add" method="POST">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">T√™n s·∫£n ph·∫©m</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">H√£ng</label>
                            <input type="text" name="brand" class="form-control" list="brands" required>
                            <datalist id="brands"><option value="Apple"><option value="Samsung"><option value="Xiaomi"><option value="Oppo"></datalist>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Gi√° b√°n (VNƒê)</label>
                            <input type="number" name="price" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-success">S·ªë l∆∞·ª£ng t·ªìn kho</label>
                            <input type="number" name="stock_quantity" class="form-control border-success" value="10" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Lo·∫°i</label>
                            <select name="category" class="form-select">
                                <option value="phone">ƒêi·ªán tho·∫°i</option>
                                <option value="accessory">Ph·ª• ki·ªán</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">URL H√¨nh ·∫£nh</label>
                            <input type="text" name="image_url" class="form-control" placeholder="https://..." required>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">M√¥ t·∫£</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-12 d-flex gap-3">
                             <div class="bg-light p-2 rounded flex-grow-1">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="activeSwitch" checked>
                                    <label class="form-check-label fw-bold" for="activeSwitch">Active</label>
                                </div>
                            </div>
                            <div class="bg-light p-2 rounded flex-grow-1">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_sale" id="saleSwitch">
                                    <label class="form-check-label fw-bold" for="saleSwitch">Gi·∫£m gi√°?</label>
                                </div>
                                <input type="number" name="sale_price" class="form-control mt-2 form-control-sm" placeholder="Gi√° sau gi·∫£m">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal ƒê·ªãnh gi√° -->
<div class="modal fade" id="valuationModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/admin/tradein/update" method="POST">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ƒê·ªãnh gi√° thi·∫øt b·ªã</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="valId">
                    <p>Thi·∫øt b·ªã: <strong id="valDevice"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Gi√° thu mua</label>
                        <input type="number" name="valuation_price" class="form-control fw-bold text-success">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫</label>
                        <textarea name="admin_note" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="action" value="reject" class="btn btn-secondary">T·ª´ ch·ªëi</button>
                    <button type="submit" name="action" value="approve" class="btn btn-success fw-bold">X√°c nh·∫≠n</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function openValuationModal(id, name) {
        document.getElementById('valId').value = id;
        document.getElementById('valDevice').innerText = name;
        new bootstrap.Modal(document.getElementById('valuationModal')).show();
    }

    // Logic S·∫Øp x·∫øp b·∫£ng S·∫£n ph·∫©m
    let sortOrders = {};

    function sortProductTable(n, type) {
        const table = document.getElementById("productTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        // ƒê·∫£o chi·ªÅu s·∫Øp x·∫øp
        sortOrders[n] = !sortOrders[n];
        const isAsc = sortOrders[n];

        rows.sort((a, b) => {
            let valA = a.cells[n].innerText.trim();
            let valB = b.cells[n].innerText.trim();

            if (type === 'int') {
                // X·ª≠ l√Ω chu·ªói s·ªë (b·ªè d·∫•u #, d·∫•u ph·∫©y, ch·ªØ ƒë)
                valA = parseInt(valA.replace(/[^\d]/g, '')) || 0;
                valB = parseInt(valB.replace(/[^\d]/g, '')) || 0;
                return isAsc ? valA - valB : valB - valA;
            } else {
                // S·∫Øp x·∫øp chu·ªói vƒÉn b·∫£n Ti·∫øng Vi·ªát
                return isAsc ? valA.localeCompare(valB, 'vi') : valB.localeCompare(valA, 'vi');
            }
        });

        // C·∫≠p nh·∫≠t l·∫°i giao di·ªán b·∫£ng
        rows.forEach(row => tbody.appendChild(row));

        // C·∫≠p nh·∫≠t icon s·∫Øp x·∫øp
        const headers = table.querySelectorAll("th.th-sort");
        headers.forEach((th, idx) => {
            const icon = th.querySelector(".sort-icon");
            if (icon) {
                // n l√† c·ªôt ƒë∆∞·ª£c click, nh∆∞ng headers ch·ªâ t√≠nh c√°c c·ªôt th-sort
                // Ch√∫ng ta c·∫ßn t√¨m th ƒë√∫ng d·ª±a tr√™n v·ªã tr√≠ index th·ª±c t·∫ø
                const thIdx = Array.from(table.querySelectorAll("th")).indexOf(th);
                if (thIdx === n) {
                    icon.className = isAsc ? "fas fa-sort-up sort-icon sort-active" : "fas fa-sort-down sort-icon sort-active";
                } else {
                    icon.className = "fas fa-sort sort-icon";
                }
            }
        });
    }
</script>
{% endblock %}