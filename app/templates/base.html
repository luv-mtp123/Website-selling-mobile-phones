<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Store - Xu√¢n B√≠nh Ng·ªç 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- [NEW] Th√™m th∆∞ vi·ªán SweetAlert2 cho Th√¥ng b√°o ƒë·∫πp m·∫Øt -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --tet-red: #d70018;
            --tet-gold: #ffc107;
        }
        body {
            background-color: #fff9f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Navbar C·ªï Truy·ªÅn */
        .navbar {
            background: linear-gradient(90deg, #d70018 0%, #b30014 100%);
            box-shadow: 0 4px 15px rgba(215, 0, 24, 0.3);
        }
        .navbar-brand { font-weight: 900; font-size: 1.6rem; color: #fff !important; text-shadow: 0px 2px 4px rgba(0,0,0,0.3); }
        .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 600; transition: all 0.3s; }
        .nav-link:hover { color: var(--tet-gold) !important; transform: translateY(-2px); text-shadow: 0 0 10px rgba(255, 193, 7, 0.6); }

        .ai-badge { background: linear-gradient(45deg, #ff9a9e, #fecfef); color: #d70018; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }

        /* N√∫t gi·ªè h√†ng */
        .cart-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white !important; transition: 0.3s; }
        .cart-btn:hover { background: var(--tet-gold); color: #d70018 !important; border-color: var(--tet-gold); }

        /* Chatbot Widget & Animation */
        .chatbot-btn { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; border-radius: 50%; background: linear-gradient(135deg, var(--tet-gold), #ff9800); color: #b30014; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 1000; animation: bounce 3s infinite; border: 3px solid white; }
        .chatbot-window { position: fixed; bottom: 100px; right: 30px; width: 350px; height: 450px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 1000; display: none; flex-direction: column; overflow: hidden; border: 2px solid var(--tet-red); }
        .chat-header { background: var(--tet-red); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #fff5f5; }
        .chat-footer { padding: 10px; border-top: 1px solid #fee; display: flex; background: #fff; }
        .chat-msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 20px; max-width: 85%; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-bot { background: white; border: 1px solid #fecfef; align-self: flex-start; color: #333; border-bottom-left-radius: 5px; }
        .chat-user { background: var(--tet-red); color: white; margin-left: auto; border-bottom-right-radius: 5px; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-15px);} 60% {transform: translateY(-7px);} }

        /* C√¢u ƒë·ªëi T·∫øt 3D */
        .tet-couplet { position: fixed; top: 12%; width: 85px; background: linear-gradient(180deg, #c62828 0%, #b71c1c 100%); color: #ffeb3b; border: 3px solid #fbc02d; border-radius: 12px; padding: 20px 5px; text-align: center; font-weight: 900; font-family: 'Times New Roman', serif; font-size: 24px; line-height: 1.6; box-shadow: 5px 10px 20px rgba(0,0,0,0.4), inset 0 0 10px rgba(0,0,0,0.5); z-index: 900; display: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.6); }
        .tet-couplet.left { left: 20px; }
        .tet-couplet.right { right: 20px; }
        @media (min-width: 1400px) { .tet-couplet { display: block; animation: float 4s ease-in-out infinite; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* L·ªìng ƒë√®n tr√¥i (Decor g√≥c) */
        .lantern-decor { position: fixed; top: -10px; right: 120px; width: 60px; z-index: 1000; animation: swing 3s ease-in-out infinite alternate; transform-origin: top center; pointer-events: none; }
        @keyframes swing { 0% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }

        /* Hi·ªáu ·ª©ng v·∫≠t th·ªÉ r∆°i (Hoa ƒë√†o/L√¨ x√¨) */
        .petal { position: fixed; top: -50px; z-index: 9999; pointer-events: none; user-select: none; animation: fall linear forwards; opacity: 0.9; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        @keyframes fall { 0% { transform: translateY(0) rotate(0deg) translateX(0); opacity: 1; } 100% { transform: translateY(105vh) rotate(720deg) translateX(100px); opacity: 0; } }
    </style>
</head>
<body>
    <!-- Decor T·∫øt -->
    <div class="tet-couplet left">üå∏<br>T√ÇN<br>NI√äN<br>PH√ö<br>QU√ù</div>
    <div class="tet-couplet right">üí∞<br>T·∫§N<br>T√ÄI<br>T·∫§N<br>L·ªòC</div>
    <img src="https://cdn-icons-png.flaticon.com/512/10427/10427181.png" class="lantern-decor d-none d-lg-block" alt="Lantern">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-fan fa-spin text-warning me-2" style="animation-duration: 4s;"></i>MobileStore
            </a>
            <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="fas fa-bars text-white fs-3"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Trang ch·ªß</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="/compare">
                            <i class="fas fa-balance-scale me-1"></i>So s√°nh AI <span class="ai-badge">HOT</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-warning" href="/trade-in"><i class="fas fa-sync-alt me-1"></i>Thu C≈©</a>
                    </li>
                </ul>
                <ul class="navbar-nav align-items-center gap-2">
                    <!-- Gi·ªè h√†ng -->
                    <li class="nav-item me-2">
                        <a class="nav-link cart-btn rounded-circle position-relative" href="/cart" style="width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-shopping-cart"></i>
                            {% if session.get('cart') %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark border border-2 border-danger" style="font-size: 0.7rem;">
                                {{ session.get('cart')|length }}
                            </span>
                            {% endif %}
                        </a>
                    </li>

                    {% if current_user.is_authenticated %}
                        {% if current_user.role == 'admin' %}
                            <li class="nav-item"><a class="btn btn-warning btn-sm text-danger fw-bold rounded-pill px-3 me-2" href="/admin"><i class="fas fa-cog"></i> Qu·∫£n Tr·ªã</a></li>
                        {% endif %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDrop" role="button" data-bs-toggle="dropdown">
                                <img src="{{ current_user.avatar_url or 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' }}" class="rounded-circle border border-2 border-warning me-2" width="30" height="30" style="object-fit: cover;">
                                {{ current_user.full_name or current_user.username }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2">
                                <li><a class="dropdown-item" href="/dashboard"><i class="fas fa-user-circle me-2 text-primary"></i>H·ªì s∆° & ƒê∆°n h√†ng</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="/login">ƒêƒÉng nh·∫≠p</a></li>
                        <li class="nav-item"><a class="btn btn-warning text-danger btn-sm ms-2 px-4 rounded-pill fw-bold shadow-sm" href="/register">ƒêƒÉng k√Ω ngay</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- [NEW] SweetAlert2 Thay th·∫ø Bootstrap Toasts (Fix Syntax Error) -->
    <div id="flash-messages" style="display: none;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <span class="flash-msg" data-category="{{ category }}" data-message="{{ message }}"></span>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // L·∫•y danh s√°ch c√°c th√¥ng b√°o Flash t·ª´ HTML elements ƒë·ªÉ tr√°nh l·ªói c√∫ ph√°p JS
            const flashElements = document.querySelectorAll('.flash-msg');
            flashElements.forEach(el => {
                const category = el.getAttribute('data-category');
                const message = el.getAttribute('data-message');

                let iconType = 'info';
                if (category === 'success') iconType = 'success';
                else if (category === 'danger') iconType = 'error';
                else if (category === 'warning') iconType = 'warning';

                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: iconType,
                    title: message,
                    showConfirmButton: false,
                    timer: 3500, // T·ª± ƒë·ªông ƒë√≥ng sau 3.5s
                    timerProgressBar: true,
                    customClass: {
                        popup: 'colored-toast'
                    },
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                });
            });
        });
    </script>

    <!-- Main Content -->
    <div class="container mt-4 mb-5" style="min-height: 75vh;">
        {% block content %}{% endblock %}
    </div>

    <!-- Footer -->
    <footer class="text-white py-4 mt-auto" style="background: linear-gradient(180deg, #b30014 0%, #800000 100%);">
        <div class="container text-center">
            <h5 class="fw-bold text-warning mb-3"><i class="fas fa-horse-head me-2"></i>XU√ÇN B√çNH NG·ªå 2026</h5>
            <div class="mb-3">
                <i class="fab fa-facebook fa-2x mx-3 cursor-pointer"></i>
                <i class="fab fa-youtube fa-2x mx-3 cursor-pointer"></i>
            </div>
            <p class="mb-0 small opacity-75">&copy; 2026 MobileStore. T·ªëi ∆∞u h√≥a b·ªüi AI.</p>
        </div>
    </footer>

    <!-- Chatbot Widget -->
    <div class="chatbot-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>
    <div class="chatbot-window" id="chatWindow">
        <div class="chat-header">
            <span><i class="fas fa-comments text-warning me-2"></i> Tr·ª£ l√Ω L√¨ X√¨ AI</span>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="d-flex mb-3"><div class="chat-msg chat-bot shadow-sm">Ch√†o b·∫°n! Ch√∫c m·ª´ng nƒÉm m·ªõi! üßß M√¨nh c√≥ th·ªÉ t∆∞ v·∫•n s·∫£n ph·∫©m g√¨ cho b·∫°n h√¥m nay?</div></div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chatInput" class="form-control me-2 rounded-pill bg-light border-0 px-3" placeholder="Nh·∫≠p c√¢u h·ªèi..." onkeypress="if(event.keyCode==13) sendChat()">
            <button class="btn btn-danger rounded-circle" style="width: 45px; height: 45px;" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleChat() {
            var chatWin = document.getElementById('chatWindow');
            chatWin.style.display = (chatWin.style.display === 'none' || chatWin.style.display === '') ? 'flex' : 'none';
        }

        async function sendChat() {
            var input = document.getElementById('chatInput');
            var msg = input.value.trim();
            if(!msg) return;
            var body = document.getElementById('chatBody');
            body.innerHTML += `<div class="d-flex justify-content-end mb-3"><div class="chat-msg chat-user shadow-sm">${msg}</div></div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;
            try {
                const res = await fetch('/api/chatbot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                const data = await res.json();
                body.innerHTML += `<div class="d-flex mb-3"><div class="chat-msg chat-bot shadow-sm">${data.response}</div></div>`;
                body.scrollTop = body.scrollHeight;
            } catch (e) { console.error(e); }
        }

        function createPetal() {
            const petal = document.createElement('div');
            petal.classList.add('petal');
            const items = ['üå∏', 'üßß', '‚ú®', 'ü™ô', 'üå∏'];
            petal.innerText = items[Math.floor(Math.random() * items.length)];
            petal.style.left = Math.random() * 100 + 'vw';
            petal.style.animationDuration = Math.random() * 4 + 6 + 's';
            petal.style.fontSize = Math.random() * 10 + 15 + 'px';
            document.body.appendChild(petal);
            setTimeout(() => { petal.remove(); }, 10000);
        }
        setInterval(createPetal, 700);
    </script>
</body>
</html>