{% extends 'base.html' %}

{% block content %}
<style>
    /* --- Product Info Styles --- */
    .product-title { font-size: 1.8rem; font-weight: 800; color: #212529; margin-bottom: 10px; }
    .price-current { color: #d70018; font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; }
    .price-old { text-decoration: line-through; color: #999; font-size: 1.2rem; margin-left: 10px; }

    /* --- Variant Buttons --- */
    .variant-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .btn-variant {
        border: 1px solid #dee2e6; border-radius: 10px; padding: 10px 20px; background: #fff;
        color: #495057; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; min-width: 90px;
        text-align: center; position: relative; font-weight: 600; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
    }
    .btn-variant:hover { border-color: #d70018; background-color: #fff5f5; color: #d70018; }
    .btn-variant.active { border-color: #d70018; color: #d70018; background: #fff0f0; box-shadow: 0 0 0 1px #d70018 inset; }
    .btn-variant.active::after {
        content: '✔'; position: absolute; top: -8px; right: -8px; background: #d70018; color: white;
        font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* --- Action Buttons --- */
    .btn-buy-now {
        background: linear-gradient(135deg, #d70018 0%, #ff0000 100%); color: white; border: none; width: 100%; padding: 14px;
        border-radius: 12px; font-weight: 800; text-transform: uppercase; font-size: 1.2rem; box-shadow: 0 8px 20px rgba(215, 0, 24, 0.25); transition: all 0.3s;
    }
    .btn-buy-now:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(215, 0, 24, 0.35); color: white; }

    .btn-add-cart {
        border: 2px solid #d70018; color: #d70018; background: white; width: 100%; padding: 10px; border-radius: 12px;
        font-weight: 700; text-transform: uppercase; font-size: 0.75rem; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s;
    }
    .btn-add-cart:hover { background: #d70018; color: white; }

    .btn-disabled { background: #e9ecef !important; border-color: #dee2e6 !important; cursor: not-allowed; box-shadow: none !important; color: #adb5bd !important; pointer-events: none; }

    /* --- Rating Stars --- */
    .rating { display: flex; flex-direction: row-reverse; justify-content: flex-start; gap: 5px; }
    .rating input { display: none; }
    .rating label { font-size: 2rem; color: #e9ecef; cursor: pointer; transition: color 0.2s; }
    .rating input:checked ~ label, .rating label:hover, .rating label:hover ~ label { color: #ffc107; }

    /* --- Image Gallery --- */
    .main-image-container {
        padding: 30px;
        background: white;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
    }
    .main-image-container:hover img { transform: scale(1.05); }
    .main-image-container img { transition: transform 0.3s ease; max-height: 450px; }
</style>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="my-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted fw-bold"><i class="fas fa-home me-1"></i>Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="/?brand={{ product.brand }}" class="text-decoration-none text-muted">{{ product.brand }}</a></li>
        <li class="breadcrumb-item active text-dark fw-bold" aria-current="page">{{ product.name }}</li>
    </ol>
</nav>

<div class="row g-4 mb-5">
    <!-- Cột TRÁI: Hình ảnh -->
    <div class="col-lg-5">
        <div class="main-image-container shadow-sm border position-relative">
            <img id="mainImage" src="{{ product.image_url }}" class="img-fluid" alt="{{ product.name }}" onerror="this.src='https://via.placeholder.com/500x500?text=No+Image'">
            {% if product.is_sale %}
            <div class="position-absolute top-0 start-0 m-3 badge bg-danger fs-6 shadow-sm px-3 py-2 rounded-pill">
                <i class="fas fa-bolt me-1"></i> Giảm sốc
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Cột PHẢI: Thông tin & Mua hàng -->
    <div class="col-lg-7">
        <div class="bg-white p-4 rounded-4 shadow-sm border h-100">
            <h1 class="product-title">{{ product.name }}</h1>

            <div class="d-flex align-items-center mb-3">
                <span class="badge bg-warning text-dark me-2"><i class="fas fa-star me-1"></i>4.9/5</span>
                <span class="text-muted small">Đã bán 1.2k+</span>
                <div class="vr mx-3"></div>
                {% if product.stock_quantity > 0 %}
                    <span class="text-success fw-bold"><i class="fas fa-check-circle me-1"></i>Còn hàng ({{ product.stock_quantity }})</span>
                {% else %}
                    <span class="text-danger fw-bold"><i class="fas fa-times-circle me-1"></i>Tạm hết hàng</span>
                {% endif %}
            </div>

            <div class="mb-4 p-3 bg-light rounded-3 border d-flex align-items-center">
                {% if product.is_sale %}
                    <span id="priceDisplay" class="price-current">{{ product.sale_price | vnd }}</span>
                    <span id="oldPriceDisplay" class="price-old">{{ product.price | vnd }}</span>
                    <span class="badge bg-danger ms-3 rounded-pill">-{{ ((1 - product.sale_price/product.price)*100)|round|int }}%</span>
                {% else %}
                    <span id="priceDisplay" class="price-current">{{ product.price | vnd }}</span>
                {% endif %}
            </div>

            {% if product.category == 'phone' %}
                <!-- Phiên bản -->
                {% if product.versions_list %}
                <div class="mb-3">
                    <label class="fw-bold mb-2 text-dark small text-uppercase">Chọn phiên bản</label>
                    <div class="variant-group">
                        {% for ver in product.versions_list %}
                        <div class="btn-variant {% if loop.first %}active{% endif %}" onclick="updatePrice(this, '{{ ver.price }}')">
                            <span>{{ ver.name }}</span><small class="text-muted">{{ ver.price | vnd }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Màu sắc -->
                {% if product.colors_list %}
                <div class="mb-4">
                    <label class="fw-bold mb-2 text-dark small text-uppercase">Chọn màu sắc</label>
                    <div class="variant-group">
                        {% for col in product.colors_list %}
                        <div class="btn-variant {% if loop.first %}active{% endif %}" onclick="updateImage(this, '{{ col.image }}')">
                            <div class="d-flex align-items-center gap-2">
                                {% if col.image and col.image != 'None' %}
                                    <img src="{{ col.image }}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid #dee2e6;">
                                {% endif %}
                                {{ col.name }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <!-- Nút Mua (Disabled nếu hết hàng) -->
            <div class="mt-auto">
                {% if product.stock_quantity > 0 %}
                    <div class="row g-2">
                        <div class="col-9">
                            <form action="/cart/add/{{ product.id }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-buy-now">
                                    MUA NGAY <br>
                                    <span style="font-size: 0.75rem; font-weight: normal; opacity: 0.9">Giao tận nơi hoặc nhận tại cửa hàng</span>
                                </button>
                            </form>
                        </div>
                        <div class="col-3">
                            <form action="/cart/add/{{ product.id }}" method="POST" class="h-100">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-add-cart">
                                    <i class="fas fa-cart-plus fs-3 mb-1"></i>
                                    <span>Thêm giỏ</span>
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <button class="btn btn-buy-now btn-disabled" disabled>HẾT HÀNG</button>
                    <p class="text-danger mt-2 small fw-bold"><i class="fas fa-bell me-1"></i> Sản phẩm đang tạm hết. Vui lòng quay lại sau.</p>
                {% endif %}
            </div>

            <!-- Policy Box -->
            <div class="mt-4 pt-3 border-top">
                <div class="row small text-muted">
                    <div class="col-6 mb-2"><i class="fas fa-box-open me-2 text-primary"></i>Bộ sản phẩm chuẩn</div>
                    <div class="col-6 mb-2"><i class="fas fa-shield-alt me-2 text-primary"></i>Bảo hành 12 tháng</div>
                    <div class="col-6"><i class="fas fa-sync me-2 text-primary"></i>Đổi trả 30 ngày</div>
                    <div class="col-6"><i class="fas fa-truck me-2 text-primary"></i>Freeship toàn quốc</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- [SECTION] BÌNH LUẬN & ĐÁNH GIÁ -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
            <div class="card-header bg-gradient bg-light p-3 border-bottom d-flex align-items-center">
                <h5 class="fw-bold mb-0 text-primary"><i class="fas fa-comments me-2"></i> Đánh giá từ khách hàng</h5>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <!-- Form gửi đánh giá -->
                    <div class="col-md-4 mb-4 mb-md-0 border-end">
                        <h6 class="fw-bold mb-3">Gửi nhận xét của bạn</h6>
                        {% if current_user.is_authenticated %}
                        <form action="/product/{{ product.id }}/comment" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3 text-center">
                                <label class="form-label text-muted small fw-bold">BẠN CẢM THẤY THẾ NÀO?</label>
                                <div class="rating justify-content-center">
                                    <input type="radio" name="rating" value="5" id="5" checked><label for="5" title="Tuyệt vời">★</label>
                                    <input type="radio" name="rating" value="4" id="4"><label for="4" title="Tốt">★</label>
                                    <input type="radio" name="rating" value="3" id="3"><label for="3" title="Bình thường">★</label>
                                    <input type="radio" name="rating" value="2" id="2"><label for="2" title="Tệ">★</label>
                                    <input type="radio" name="rating" value="1" id="1"><label for="1" title="Rất tệ">★</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <textarea name="content" class="form-control bg-light border-0" rows="4" placeholder="Hãy chia sẻ cảm nhận về sản phẩm..." required style="resize: none;"></textarea>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary rounded-pill fw-bold">Gửi Đánh Giá</button>
                            </div>
                        </form>
                        {% else %}
                        <div class="text-center py-4 bg-light rounded-3">
                            <i class="fas fa-lock fa-2x text-muted mb-2"></i>
                            <p class="mb-3 text-muted">Vui lòng đăng nhập để đánh giá</p>
                            <a href="/login" class="btn btn-outline-primary rounded-pill px-4 btn-sm">Đăng nhập ngay</a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Danh sách đánh giá -->
                    <div class="col-md-8 ps-md-4">
                        <h6 class="fw-bold mb-3">Bình luận mới nhất ({{ comments|length }})</h6>
                        <div class="d-flex flex-column gap-3" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                            {% if comments %}
                                {% for c in comments %}
                                <div class="d-flex p-3 bg-light rounded-3 border-0">
                                    <img src="{{ c.user.avatar_url or 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png' }}"
                                         class="rounded-circle me-3 border shadow-sm" width="50" height="50" style="object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <h6 class="fw-bold mb-0 text-dark">{{ c.user.full_name or c.user.username }}</h6>
                                            <small class="text-muted" style="font-size: 0.75rem;">{{ c.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        </div>
                                        <div class="mb-2">
                                            {% for i in range(c.rating) %}<i class="fas fa-star text-warning small"></i>{% endfor %}
                                            {% for i in range(5 - c.rating) %}<i class="far fa-star text-muted small opacity-25"></i>{% endfor %}
                                        </div>
                                        <p class="mb-0 text-secondary small">{{ c.content }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1144/1144811.png" width="60" class="opacity-25 mb-3">
                                    <p class="text-muted">Chưa có đánh giá nào. Hãy là người đầu tiên!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gợi ý (Giữ nguyên logic) -->
<div class="mt-5 mb-5">
    <div class="d-flex align-items-center mb-4">
        <h4 class="fw-bold text-uppercase mb-0 text-danger">Gợi ý phụ kiện</h4>
        <div class="flex-grow-1 ms-3 border-bottom"></div>
    </div>
    <div class="row row-cols-2 row-cols-md-4 g-3">
        {% for item in recommendations %}
        <div class="col">
            <div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden">
                <a href="/product/{{ item.id }}" class="text-center p-3 bg-white position-relative">
                    <img src="{{ item.image_url }}" class="img-fluid" style="height: 140px; object-fit: contain;">
                </a>
                <div class="card-body p-3 bg-light">
                    <h6 class="card-title text-truncate mb-1"><a href="/product/{{ item.id }}" class="text-decoration-none text-dark fw-bold small">{{ item.name }}</a></h6>
                    <div class="text-danger fw-bold">{{ item.price | vnd }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function formatVND(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n).replace('₫', 'đ'); }
    function updateImage(el, imageUrl) {
        el.parentElement.querySelectorAll('.btn-variant').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        if(imageUrl && imageUrl != 'None' && imageUrl != '') document.getElementById('mainImage').src = imageUrl;
    }
    function updatePrice(el, price) {
        el.parentElement.querySelectorAll('.btn-variant').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        if(price) {
            document.getElementById('priceDisplay').innerText = formatVND(price);
            const oldPrice = document.getElementById('oldPriceDisplay');
            if(oldPrice) oldPrice.style.display = 'none';
        }
    }
</script>
{% endblock %}