{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="col-md-5">
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
            <div class="card-header bg-success text-white text-center py-3">
                <h4 class="mb-0 fw-bold"><i class="fas fa-qrcode me-2"></i> Thanh To√°n Qua QR Code</h4>
            </div>
            <div class="card-body p-4 text-center">
                <!-- V√πng hi·ªÉn th·ªã th·ªùi gian ƒë·∫øm ng∆∞·ª£c -->
                <div class="mb-4">
                    <div class="text-muted small mb-1 text-uppercase fw-bold">Giao d·ªãch s·∫Ω h·∫øt h·∫°n sau</div>
                    <span class="badge bg-danger fs-4 rounded-pill px-4 py-2 shadow-sm">
                        <i class="fas fa-clock me-2"></i>
                        <span id="timer">03:00</span>
                    </span>
                </div>

                <p class="text-muted mb-3">Vui l√≤ng qu√©t m√£ b√™n d∆∞·ªõi ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng</p>

                <!-- Khu v·ª±c hi·ªÉn th·ªã QR v√† Tr·∫°ng th√°i -->
                <div class="p-3 border rounded-4 bg-light d-inline-block mb-4 position-relative shadow-sm">
                    <img src="{{ qr_url }}" alt="VietQR" class="img-fluid" style="max-width: 280px; border-radius: 10px;">
                    <div class="mt-3 fw-bold text-primary fs-3">{{ order.total_price | vnd }}</div>

                    <hr class="my-3">

                    <!-- Tr·∫°ng th√°i ch·ªù x·ª≠ l√Ω -->
                    <div id="payment-status" class="text-warning fw-bold animate__animated animate__pulse animate__infinite">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        ƒêang ch·ªù h·ªá th·ªëng ghi nh·∫≠n...
                    </div>
                </div>

                <!-- Th√¥ng tin h∆∞·ªõng d·∫´n -->
                <div class="alert alert-warning text-start small border-0 shadow-sm mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i> <strong>L∆∞u √Ω quan tr·ªçng:</strong>
                    <ul class="mb-0 mt-2 ps-3">
                        <li>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông x√°c nh·∫≠n sau khi b·∫°n chuy·ªÉn kho·∫£n th√†nh c√¥ng.</li>
                        <li>Vui l√≤ng gi·ªØ nguy√™n n·ªôi dung chuy·ªÉn kho·∫£n ƒë·ªÉ AI nh·∫≠n di·ªán ƒë∆°n h√†ng.</li>
                        <li><strong>Kh√¥ng</strong> t·ª± √Ω tho√°t trang n√†y cho ƒë·∫øn khi nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o th√†nh c√¥ng.</li>
                    </ul>
                </div>

                <!-- Link gi·∫£ l·∫≠p d√†nh cho m√¥i tr∆∞·ªùng Test -->
                <div class="p-3 bg-light rounded-3 mb-4 text-start border">
                    <div class="fw-bold text-danger mb-1 small"><i class="fas fa-vial me-1"></i> CH·∫æ ƒê·ªò TH·ª¨ NGHI·ªÜM (LOCAL):</div>
                    <div class="small text-muted">V√¨ kh√¥ng c√≥ ng√¢n h√†ng th·∫≠t, h√£y m·ªü link d∆∞·ªõi ƒë√¢y ·ªü tab kh√°c ƒë·ªÉ gi·∫£ l·∫≠p thanh to√°n th√†nh c√¥ng:</div>
                    <a href="/test/simulate-bank-success/{{ order.id }}" target="_blank" class="btn btn-sm btn-dark mt-2 w-100 rounded-pill">
                        G·ª≠i t√≠n hi·ªáu "ƒê√É NH·∫¨N TI·ªÄN" <i class="fas fa-external-link-alt ms-1"></i>
                    </a>
                </div>

                <a href="/dashboard" class="text-decoration-none text-muted small"><i class="fas fa-arrow-left me-1"></i> ƒê·ªÉ l·∫°i ƒë∆°n h√†ng v√† thanh to√°n sau</a>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Kh·ªüi t·∫°o bi·∫øn th·ªùi gian t·ª´ Server
    let timeLeft = {{ remaining_seconds }};
    const timerElem = document.getElementById('timer');
    const statusElem = document.getElementById('payment-status');

    // 2. H√†m ƒë·∫øm ng∆∞·ª£c (Countdown)
    const countdown = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(countdown);
            clearInterval(checkPayment); // D·ª´ng lu√¥n vi·ªác check API
            timerElem.innerText = "H·∫øt gi·ªù!";

            Swal.fire({
                icon: 'error',
                title: 'Giao d·ªãch h·∫øt h·∫°n!',
                text: 'ƒê√£ qu√° 3 ph√∫t k·ªÉ t·ª´ khi t·∫°o m√£. Vui l√≤ng t·∫°o ƒë∆°n h√†ng m·ªõi.',
                confirmButtonText: 'Quay l·∫°i c·ª≠a h√†ng',
                confirmButtonColor: '#d33',
                allowOutsideClick: false
            }).then(() => {
                window.location.href = "/";
            });
        } else {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElem.innerText = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
    }, 1000);

    // 3. H√†m ki·ªÉm tra tr·∫°ng th√°i t·ª± ƒë·ªông (Polling)
    const checkPayment = setInterval(async () => {
        try {
            // G·ªçi API ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng
            const response = await fetch('/api/payment/check/{{ order.id }}');
            const data = await response.json();

            // N·∫øu tr·∫°ng th√°i chuy·ªÉn sang 'Confirmed' (do link gi·∫£ l·∫≠p k√≠ch ho·∫°t)
            if (data.status === 'Confirmed' || data.status === 'Paid' || data.status === 'Completed') {
                clearInterval(checkPayment);
                clearInterval(countdown);

                // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                statusElem.innerHTML = '<i class="fas fa-check-circle me-2 text-success"></i><span class="text-success">Thanh to√°n th√†nh c√¥ng!</span>';
                statusElem.classList.remove('text-warning', 'animate__infinite');

                // Hi·ªán Pop-up ch√∫c m·ª´ng b·∫±ng SweetAlert2
                Swal.fire({
                    icon: 'success',
                    title: 'S·∫Øm T·∫øt Th√†nh C√¥ng! üßß',
                    text: 'H·ªá th·ªëng ƒë√£ nh·∫≠n ƒë∆∞·ª£c ti·ªÅn. ƒê∆°n h√†ng c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã.',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    allowOutsideClick: false
                }).then(() => {
                    window.location.href = "/dashboard";
                });
            } else if (data.status === 'Cancelled' || data.status === 'Expired') {
                window.location.href = "/dashboard";
            }
        } catch (error) {
            console.error("L·ªói ƒë·ªìng b·ªô thanh to√°n:", error);
        }
    }, 3000); // Ki·ªÉm tra m·ªói 3 gi√¢y m·ªôt l·∫ßn
</script>

<style>
    /* Hi·ªáu ·ª©ng nh·ªãp tim cho ph·∫ßn tr·∫°ng th√°i ƒëang ch·ªù */
    .animate__pulse {
        animation-duration: 2s;
    }
</style>
{% endblock %}